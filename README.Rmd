---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# diseasenowcasting

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/diseasenowcasting)](https://CRAN.R-project.org/package=diseasenowcasting)
[![Codecov test coverage](https://codecov.io/gh/RodrigoZepeda/diseasenowcasting/graph/badge.svg)](https://app.codecov.io/gh/RodrigoZepeda/diseasenowcasting)
[![R-CMD-check](https://github.com/RodrigoZepeda/diseasenowcasting/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/RodrigoZepeda/diseasenowcasting/actions/workflows/R-CMD-check.yaml)
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
<!-- badges: end -->

## Installation

You can install the development version of the package using the `remotes` package: 

```{r}
#install.packages("remotes")
remotes::install_github("RodrigoZepeda/diseasenowcasting")
```

Installation will take a while as it requires `C++` compilation. Please be patient. 

## Tutorials

Go to our website to find the different tutorials

- [Getting started](https://rodrigozepeda.github.io/diseasenowcasting/articles/Introduction.html)

## Example

<!-- TODO: FIX THIS PART USING THE NEW FUNCTIONS-->

```{r, message=FALSE}
library(diseasenowcasting)
library(ggplot2)
library(dplyr)
library(posterior)

set.seed(32658235)

# Create a fake disease process
num_steps  <- 15
num_strata <- 2
num_delays <- 10
sims       <- simulate_process_for_testing(num_steps = num_steps, 
                                           num_strata = num_strata, num_delays = num_delays)

# Now use model to predict disease process. If no strata is required omit the strata option
predictions <- nowcast(sims, "true_date", "report_date", strata = ".strata",
                       method = "variational")

#Get the predicted values in a nice format
predicted_values <- predictions$generated_quantities |>
  as_draws() |>
  subset_draws("N_predict") |>
  summarise_draws() |>
  mutate(.strata = as.numeric(stringr::str_remove_all(variable,".*\\[.*,|\\]"))) |>
  mutate(.tval = as.numeric(stringr::str_remove_all(variable,".*\\[|,.*\\]"))) |> 
  left_join(
    predictions$data$preprocessed_data |> distinct(.tval, true_date)
  ) |>
  left_join(
    predictions$data$strata_dict
  ) |> 
  mutate(.strata = .strata_unified)
  

# Sum over all delays
data_delays <- sims |>
  group_by(true_date, .strata) |>
  summarise(n = sum(n)) 

# Create plot
ggplot(data_delays) +
  geom_ribbon(aes(x = true_date, ymin = q5, ymax = q95, fill = as.character(.strata)), 
              data = predicted_values, linetype = "dotted", alpha = 0.5) +
  geom_line(aes(x = true_date, y = n, color = as.character(.strata))) +
  geom_line(aes(x = true_date, y = mean, color = as.character(.strata)), 
            data = predicted_values, linetype = "dotted") +
  theme_bw() +
  scale_color_manual("Strata", values = c("tomato3", "forestgreen")) +
  scale_fill_manual("Strata", values = c("tomato3", "forestgreen")) +
  labs(
    x = "Time",
    y = "Cases"
  )
```



