---
title: "Advanced nowcast options"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, message=FALSE, warning=FALSE}
set.seed(734586)
library(diseasenowcasting)
library(dplyr)
```

This vignette will give you an overview of the advanced options in the `nowcast()` function of the `diseasenowcasting` package including the following:

1. Using strata.
2. Adding time covariates.
3. Adding holidays.
3. Adding cycles.
4. Changing the autorregresive components. 
5. Changing the distribution.
6. Obtain a sample from the prior. 
7. Changing the priors. 

For this tutorial we will use the `mpoxdat` dataset contained in the package. 

```{r}
data(mpoxdat)
```

This contains date of diagnosis (`dx_date`), date of report to the New York Health's system (`dx_report_date`), a simulated `race` covariate and the counts of observations in that case `n`:

```{r}
mpoxdat |> head()
```

For the purpose of the example we will use the data until September 2022:

```{r}
mpox_reduced <- mpoxdat |> 
  filter(dx_report_date < as.Date("2022/09/01", format = "%Y/%m/%d"))
```

## Using strata

A nowcast can be generated by stratified covariates specifying which column (or columns) correspond to the `strata`. In our case we can specify `race` to obtain a `nowcast` stratified by race:

```{r}
ncast_race <- nowcast(mpox_reduced, true_date = "dx_date", 
                      report_date = "dx_report_date", strata = "race", refresh = 0)
```

And subsequent operations including `summary`, `plots`:

```{r}
plot(ncast_race, datesbrakes = "1 week", rowsfacet = 3, casesbrakes = 3)
```

As well as backtesting:

```{r}
#Backtesting for a random date in the past:
btest <- backtest(ncast_race, dates_to_test = as.Date("2022/08/04"), refresh = 0)
```

and calculating metrics by the strata:

```{r}
calc_wis(btest)
```

## Adding time covariates

The
